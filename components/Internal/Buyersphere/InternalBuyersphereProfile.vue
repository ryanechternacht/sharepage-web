<template>
  <div class="page-left">
    <div class="sticky top-[2rem] p-2 flex flex-col gap-1">
      <div>Timeline</div>
      <div>People</div>
      <div>Decision Criteria</div>
      <div class="flex flex-col gap-1"
        v-scroll-spy-active
        v-scroll-spy-link>

        <!-- The nested div is so scrollspy works correclty with the hrs -->
        <div>
          <hr>
          <div @click="navigateTo('#objectives')"
          class="page-link">🏆 &nbsp; Objectives</div>
        </div>
        <div>
          <div @click="navigateTo('#milestones')"
            class="page-link">🏎️ &nbsp; Milestones</div>
        </div>
        <div>
          <div @click="navigateTo('#features')"
            class="page-link">🤖 &nbsp; Features</div>
        </div>
        <div>
          <div @click="navigateTo('#constraints')"
            class="page-link">🧩 &nbsp; Constraints</div>
        </div>
        <div>
          <div @click="navigateTo('#pricing')"
            class="page-link">💵 &nbsp; Pricing</div>
        </div>
        <div>
          <div @click="navigateTo('#pricing')"
            class="page-link">🎉 &nbsp; Success Criteria</div>
        </div>
        <!-- <div>
          <div @click="navigateTo('#notes')"
            class="page-link">📒 &nbsp; Notes</div>
        </div>
        <div>
          <div @click="navigateTo('#resources')"
            class="page-link">📓 &nbsp; Resources</div>
        </div> -->
      </div>
      <div>Resources</div>
    </div>
  </div>

  
  <div class="page-center mb-20" v-scroll-spy>
    <div id="objectives"
      class="item-group">
      <div class="group-header">🏆 &nbsp; Objectives</div>
      <h4>These are the core objectives we solve</h4>
      <div class="items-list">
        <template v-for="pp in painPoints"
          class="items-list-row">
          <div class="flex flex-">
            <Tag2 color="blue" class="mx-auto">{{ pp.title }}</Tag2>
          </div>
          <div class="inline-html" v-html="pp.description" />
        </template>
      </div>

      <h4>Which ones are most important to you? Are there any not covered above?</h4>
      <TipTapTextarea v-model="problemToSolve"
        placeholder="Pain points to resolve"
        class="w-full mb-4" />
    </div>

    <div id="milestones"
      class="item-group">
      <div class="group-header">🏎️ &nbsp; Milestones</div>
      <h4>What are the key milestone dates:</h4>
      <div class="document-list">
        <div>
          <Tag2 color="blue">{{ dealTiming?.qualifiedDays }} days</Tag2>
        </div>
        <div>Qualification</div>
        <div class="gray">By {{ formatDate(buyersphere.decisionDate) }}</div>

        <div>
          <Tag2 color="blue">{{ dealTiming?.evaluationDays }} days</Tag2>
        </div>
        <div>Evaluation</div>
        <div class="gray">By {{ formatDate(buyersphere.evaluationDate) }}</div>

        <div>
          <Tag2 color="blue">{{ dealTiming?.decisionDays }} days</Tag2>
        </div>
        <div>Decision</div>
        <div class="gray">By {{ formatDate(buyersphere.decisionDate) }}</div>

        <div>
          <Tag2 color="blue">{{ dealTiming?.adoptionDays }} days</Tag2>
        </div>
        <div>Adoption</div>
        <div class="gray">By {{ formatDate(buyersphere.adoptionDate) }}</div>
      </div>
    </div>
    
    <div id="features"
      class="item-group">
      <h4>Let us know which features are important to you</h4>
      <div class="flex flex-col gap-4">
        <div v-for="(f, i) in features" 
          class="four-tile-grid">
          <Tag2 color="blue" class="mx-auto">Feature #{{ i + 1 }}</Tag2>
          <h3>{{ f.title }}</h3>
          <div class="justify-center">
            <PButton
              variant="gray"
              size="medium"
              :selected="myFeatures?.interests[f.id] === 'yes'"
              @click="saveFeatureInterest(f.id, 'yes')">✅</PButton>
            <PButton
              variant="gray"
              size="medium"
              :selected="myFeatures?.interests[f.id] === 'maybe'"
              @click="saveFeatureInterest(f.id, 'maybe')">🚧</PButton>
            <PButton
              variant="gray"
              size="medium"
              :selected="myFeatures?.interests[f.id] === 'no'"
              @click="saveFeatureInterest(f.id, 'no')">⛔</PButton>
          </div>
          <div class="gray inline-html" v-html="f.description" />
        </div>
      </div>
    </div>
   
    <div id="constraints"
      class="item-group">
      <div class="group-header">🧩 &nbsp; Constraints</div>
      <h4>Are there any constraints on your end we should know about?</h4>
      <TipTapTextarea v-model="problemToSolve"
        placeholder="Key constraints to buying"
        class="w-full mb-4" />
    </div>

    <div id="pricing"
      class="item-group">
      <div class="group-header">💵 &nbsp; Pricing</div>
      <h4>Which pricing model best fits your needs?</h4>
      <div class="flex flex-col gap-4 mb-4">
        <div v-for="pt in pricingTiers" 
          class="pricing-tier"
          :class="{'selected-pricing-tier': pt.id === buyersphere.pricingTierId}"
          @click="updatePricingTierId(pt.id)">
          <Tag2 :color="pt.id === buyersphere.pricingTierId ? 'dark-blue': 'blue'" 
            class="mx-auto">{{ pt.title }}</Tag2>
          <h3>Best for {{ pt.bestFor }}</h3>
          <h3 class="mx-auto">
            {{ pt.periodType === 'other'
              ? pt.amountOther
              : `$${format(pt.amountPerPeriod, moneyConfig)}/${periodMap[pt.periodType]}` }}
          </h3>
          <div class="gray inline-html" v-html="pt.description" />
        </div>
      </div>
    </div>

    <div id="success-criteria"
      class="item-group">
      <div class="group-header">🎉 &nbsp; Success Criteria</div>

      <h4>How will we know if this product is right for you?</h4>
      <TipTapTextarea v-model="problemToSolve"
        placeholder="Pain points to resolve"
        class="w-full mb-4" />
    </div>
    
    <!-- <div id="notes"
      class="item-group">
      <div class="group-header">📒 &nbsp; Notes</div>

      <div class="document-list">
        <template v-for="n in buyersphere.notes"
          class="items-list-row">
          <div>📒</div>
          <div>{{ n.title }}</div>
          <div class="flex flex-row items-center gap-2 justify-end">
            <div class="gray-italic">{{ formatDate(n.createdAt) }}</div>
            <UserAvatar :user="n.author" />
          </div>
        </template>
      </div>
    </div>
   
    <div id="resources"
      class="item-group" 
    >
      <div class="group-header">📓 &nbsp; Resources</div>
      <div class="document-list">
        <template v-for="r in resources"
          class="items-list-row">
          <div>📓</div>
          <div>{{ r.title }}</div>
          <div class="gray-italic text-right">{{ formatDate(r.createdAt) }}</div>
        </template>
      </div>
    </div> -->
  </div>
</template>

<script setup>
import { useBuyerspheresStore } from '@/stores/buyerspheres'
import { usePainPointsStore } from '@/stores/pain-points'
import { useFeaturesStore } from '@/stores/features'
import { useResourcesStore } from '@/stores/resources'
import { usePricingStore } from '@/stores/pricing'
import { useDealTimingStore } from '@/stores/deal-timing'
import { storeToRefs } from 'pinia'
import { format } from 'v-money3'

const route = useRoute()
const buyersphereId = parseInt(route.params.id)

const buyersphereStore = useBuyerspheresStore()
const { getBuyersphereByIdCached } = storeToRefs(buyersphereStore)

const painPointsStore = usePainPointsStore()
const { getPainPointsCached } = storeToRefs(painPointsStore)

const featuresStore = useFeaturesStore()
const { getFeaturesCached } = storeToRefs(featuresStore)

const resourcesStore = useResourcesStore()
const { getResourcesCached } = storeToRefs(resourcesStore)

const pricingStore = usePricingStore()
const { getPricingCached } = storeToRefs(pricingStore)

const dealTimingStore = useDealTimingStore()
const { getDealTimingCached } = storeToRefs(dealTimingStore)

const [buyersphere, painPoints, features, resources, { pricingTiers }, dealTiming] = await Promise.all([
  getBuyersphereByIdCached.value(buyersphereId),
  getPainPointsCached.value(),
  getFeaturesCached.value(),
  getResourcesCached.value(),
  getPricingCached.value(),
  getDealTimingCached.value(),
])

const periodMap = {
  'annually': 'yr',
  'monthly': 'mo',
  'per-seat': 'user'
}

const moneyConfig = {
  precision: 0,
  prefix: '',
  disableNegative: true,
  thousands: ',',
  suffix: ''
}

const dayjs = useDayjs()
function formatDate(date) {
  return dayjs(date).format('MMMM Do')
}

// is this worth doing for snappier UX? (probably)
const myFeatures = ref(buyersphere.featuresAnswer)

function saveFeatureInterest (featureId, answer) {
  myFeatures.value.interests[featureId] = answer
  buyersphereStore.saveFeaturesAnswer({ buyersphereId, featuresAnswer: myFeatures })
}

function updatePricingTierId (tierId) {
  buyersphereStore.savePricingTierId({ buyersphereId, pricingTierId: tierId })
}

// function makeInternalBuyersphereLink(section) {
//   return section === 'map'
//     ? `/internal/buyersphere/${route.params.id}`
//     : `/internal/buyersphere/${route.params.id}/${section}`
// }
</script>

<style lang="postcss" scoped>
.page-left {
  @apply px-6;
  grid-area: left;
}

hr {
    @apply text-cream-highlight mt-1;
  }

.page-center {
  @apply flex flex-col gap-20;
  grid-area: center;
}

.page-link {
  @apply py-1 cursor-pointer;

  &:hover {
    @apply bg-cream-highlight rounded-md;
  }
}

.active .page-link {
  @apply bg-green-primary rounded-md mx-[-.5rem] px-2 text-white;
}

.item-group {
  @apply p-8 bg-cream-background border border-cream-highlight rounded-md
    flex flex-col mt-4;

  h4 {
    @apply mb-1 mt-4 px-8 w-full text-center;
  }
}

.group-header {
  @apply p-2 flex flex-row gap-2 items-center mx-auto rounded-md 
    mt-[-2.875rem] /*-46px*/ mb-1 bg-white border border-cream-highlight;
}

.section {
  @apply p-4 bg-white border border-cream-highlight;
}

.items-list {
  @apply grid gap-y-2;
  grid-template-columns: auto 1fr;

  > * {
    @apply px-3 py-2 bg-white border-cream-highlight border-y;
  }

  > *:nth-child(2n + 1) {
    @apply rounded-l-md border-l;
  }

  > *:nth-child(2n + 2) {
    @apply rounded-r-md border-r;
  }
}

.document-list {
  @apply grid gap-y-2 items-center;
  grid-template-columns: auto 1fr 150px;

  > * {
    @apply px-3 py-2 bg-white border-cream-highlight border-y;
  }

  > *:nth-child(3n + 1) {
    @apply rounded-l-md border-l;
  }

  > *:nth-child(3n + 3) {
    @apply rounded-r-md border-r;
  }
}

.four-tile-grid {
  @apply px-6 py-4 bg-white border border-cream-highlight grid items-center gap-x-3 gap-y-1;
  grid-template-columns: auto 1fr;
  grid-template-rows: auto auto;
}

.pricing-tier {
  @apply four-tile-grid;
  @apply hover:bg-cream-background cursor-pointer;

  &.selected-pricing-tier {
    @apply bg-blue-background;
  }
}
</style>
